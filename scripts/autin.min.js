function DrawWorm(){var canvas,context,width,height,mouse={x:0,y:window.innerHeight-20},interval;this.mouse=mouse;var vms=[],MAX_NUM=100,N=80,px=500,py=500;this.initialize=function(){canvas=document.getElementById("painting"),context=canvas.getContext("2d"),width=window.innerWidth,height=window.innerHeight,canvas.width=width,canvas.height=height,canvas.addEventListener("mousemove",MouseMove,!1),canvas.addEventListener("click",MouseDown,!1);var interval=setInterval(Draw,20)};var Draw=function(){var len=vms.length,i;for(i=0;i<len;i++){var o=vms[i];o.count<N?(DrawWorm(o),o.count++):(len--,vms.splice(i,1),i--)}Check()},DrawWorm=function(obj){Math.random()>.9&&(obj.tmt.rotate(2*-obj.r),obj.r*=-1),obj.vmt.prependMatrix(obj.tmt);var cc1x=-obj.w*obj.vmt.c+obj.vmt.tx,cc1y=-obj.w*obj.vmt.d+obj.vmt.ty,pp1x=(obj.c1x+cc1x)/2,pp1y=(obj.c1y+cc1y)/2,cc2x=obj.w*obj.vmt.c+obj.vmt.tx,cc2y=obj.w*obj.vmt.d+obj.vmt.ty,pp2x=(obj.c2x+cc2x)/2,pp2y=(obj.c2y+cc2y)/2;context.fillStyle="#9DBCE1",context.strokeStyle="#FFFFFF",context.beginPath(),context.moveTo(obj.p1x,obj.p1y),context.quadraticCurveTo(obj.c1x,obj.c1y,pp1x,pp1y),context.lineTo(pp2x,pp2y),context.quadraticCurveTo(obj.c2x,obj.c2y,obj.p2x,obj.p2y),context.closePath(),context.fill(),obj.c1x=cc1x,obj.c1y=cc1y,obj.p1x=pp1x,obj.p1y=pp1y,obj.c2x=cc2x,obj.c2y=cc2y,obj.p2x=pp2x,obj.p2y=pp2y},Check=function(){var x0=mouse.x,y0=mouse.y,vx=x0-px,vy=y0-py,len=Math.min(Magnitude(vx,vy),50)+8;if(!(len<10)){var matrix=new Matrix2D;matrix.rotate(-Math.atan2(vx,vy)),matrix.translate(x0,y0),createWorm(matrix,len),context.beginPath(),context.strokeStyle="#75A0D5",context.moveTo(px,py),context.lineTo(x0,y0),context.stroke(),context.closePath(),px=x0,py=y0}},createWorm=function(mtx,len){var angle=Math.random()*(Math.PI/6-Math.PI/64)+Math.PI/64;Math.random()>.5&&(angle*=-1);var tmt=new Matrix2D;tmt.scale(.95,.95),tmt.translate(12,0);var w=.5,obj=new Worm;obj.c1x=-w*mtx.c+mtx.tx,obj.p1x=-w*mtx.c+mtx.tx,obj.c1y=-w*mtx.d+mtx.ty,obj.p1y=-w*mtx.d+mtx.ty,obj.c2x=w*mtx.c+mtx.tx,obj.p2x=w*mtx.c+mtx.tx,obj.c2y=w*mtx.d+mtx.ty,obj.p2y=w*mtx.d+mtx.ty,obj.vmt=mtx,obj.tmt=tmt,obj.r=angle,obj.w=len/20,obj.count=0,vms.push(obj),vms.length>100&&vms.shift()},Worm=function(){this.c1x=null,this.c1y=null,this.c2x=null,this.c2y=null,this.p1x=null,this.p1y=null,this.p2x=null,this.p2y=null,this.w=null,this.r=null,this.count=null,this.vmt=null,this.tmt=null},MouseDown=function(e){e.preventDefault(),canvas.width=canvas.width,vms=[]},MouseMove=function(e){mouse.x=e.layerX-canvas.offsetLeft,mouse.y=e.layerY-canvas.offsetTop},Magnitude=function(x,y){return Math.sqrt(x*x+y*y)}}function demoApp(){app.mouse.x+=20,app.mouse.x>=window.innerWidth&&window.clearInterval(interval)}var app,interval;!function(window){var Matrix2D=function(a,b,c,d,tx,ty){this.initialize(a,b,c,d,tx,ty)},p=Matrix2D.prototype;Matrix2D.identity=null,Matrix2D.DEG_TO_RAD=Math.PI/180,p.a=1,p.b=0,p.c=0,p.d=1,p.tx=0,p.ty=0,p.alpha=1,p.shadow=null,p.compositeOperation=null,p.initialize=function(a,b,c,d,tx,ty){null!=a&&(this.a=a),this.b=b||0,this.c=c||0,null!=d&&(this.d=d),this.tx=tx||0,this.ty=ty||0},p.prepend=function(a,b,c,d,tx,ty){var n11=a*this.a+b*this.c,n12=a*this.b+b*this.d,n21=c*this.a+d*this.c,n22=c*this.b+d*this.d,n31=tx*this.a+ty*this.c+this.tx,n32=tx*this.b+ty*this.d+this.ty;this.a=n11,this.b=n12,this.c=n21,this.d=n22,this.tx=n31,this.ty=n32},p.append=function(a,b,c,d,tx,ty){var a1=this.a,b1=this.b,c1=this.c,d1=this.d;this.a=a*a1+b*c1,this.b=a*b1+b*d1,this.c=c*a1+d*c1,this.d=c*b1+d*d1,this.tx=tx*a1+ty*c1+this.tx,this.ty=tx*b1+ty*d1+this.ty},p.prependMatrix=function(matrix){this.prepend(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx,matrix.ty),this.prependProperties(matrix.alpha,matrix.shadow,matrix.compositeOperation)},p.appendMatrix=function(matrix){this.append(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx,matrix.ty),this.appendProperties(matrix.alpha,matrix.shadow,matrix.compositeOperation)},p.prependTransform=function(x,y,scaleX,scaleY,rotation,skewX,skewY,regX,regY){if(rotation%360)var r=rotation*Matrix2D.DEG_TO_RAD,cos=Math.cos(r),sin=Math.sin(r);else cos=1,sin=0;(regX||regY)&&(this.tx-=regX,this.ty-=regY),skewX||skewY?(skewX*=Matrix2D.DEG_TO_RAD,skewY*=Matrix2D.DEG_TO_RAD,this.prepend(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,0,0),this.prepend(Math.cos(skewY),Math.sin(skewY),-Math.sin(skewX),Math.cos(skewX),x,y)):this.prepend(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,x,y)},p.appendTransform=function(x,y,scaleX,scaleY,rotation,skewX,skewY,regX,regY){if(rotation%360==0&&1==scaleX&&1==scaleY&&0==skewX&&0==skewY)return this.tx+=x-regX,void(this.ty+=y-regY);if(rotation%360)var r=rotation*Matrix2D.DEG_TO_RAD,cos=Math.cos(r),sin=Math.sin(r);else cos=1,sin=0;skewX||skewY?(skewX*=Matrix2D.DEG_TO_RAD,skewY*=Matrix2D.DEG_TO_RAD,this.append(Math.cos(skewY),Math.sin(skewY),-Math.sin(skewX),Math.cos(skewX),x,y),this.append(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,0,0)):this.append(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,x,y),(regX||regY)&&(this.tx-=regX*this.a+regY*this.c,this.ty-=regX*this.b+regY*this.d)},p.rotate=function(angle){var sin=Math.sin(angle),cos=Math.cos(angle),n11=cos*this.a+sin*this.c,n12=cos*this.b+sin*this.d,n21=-sin*this.a+cos*this.c,n22=-sin*this.b+cos*this.d;this.a=n11,this.b=n12,this.c=n21,this.d=n22},p.skew=function(skewX,skewY){skewX*=Matrix2D.DEG_TO_RAD,skewY*=Matrix2D.DEG_TO_RAD,this.append(Math.cos(skewY),Math.sin(skewY),-Math.sin(skewX),Math.cos(skewX),0,0)},p.scale=function(x,y){this.a*=x,this.d*=y,this.tx*=x,this.ty*=y},p.translate=function(x,y){this.tx+=x,this.ty+=y},p.identity=function(){this.alpha=this.a=this.d=1,this.b=this.c=this.tx=this.ty=0,this.shadow=this.compositeOperation=null},p.invert=function(){var a1=this.a,b1=this.b,c1=this.c,d1=this.d,tx1=this.tx,n=a1*d1-b1*c1;this.a=d1/n,this.b=-b1/n,this.c=-c1/n,this.d=a1/n,this.tx=(c1*this.ty-d1*tx1)/n,this.ty=-(a1*this.ty-b1*tx1)/n},p.isIdentity=function(){return 0==this.tx&&0==this.ty&&1==this.a&&0==this.b&&0==this.c&&1==this.d},p.decompose=function(target){null==target&&(target={}),target.x=this.tx,target.y=this.ty,target.scaleX=Math.sqrt(this.a*this.a+this.b*this.b),target.scaleY=Math.sqrt(this.c*this.c+this.d*this.d);var skewX=Math.atan2(-this.c,this.d),skewY=Math.atan2(this.b,this.a);return skewX==skewY?(target.rotation=skewY/Matrix2D.DEG_TO_RAD,this.a<0&&this.d>=0&&(target.rotation+=target.rotation<=0?180:-180),target.skewX=target.skewY=0):(target.skewX=skewX/Matrix2D.DEG_TO_RAD,target.skewY=skewY/Matrix2D.DEG_TO_RAD),target},p.reinitialize=function(a,b,c,d,tx,ty,alpha,shadow,compositeOperation){return this.initialize(a,b,c,d,tx,ty),this.alpha=alpha||1,this.shadow=shadow,this.compositeOperation=compositeOperation,this},p.appendProperties=function(alpha,shadow,compositeOperation){this.alpha*=alpha,this.shadow=shadow||this.shadow,this.compositeOperation=compositeOperation||this.compositeOperation},p.prependProperties=function(alpha,shadow,compositeOperation){this.alpha*=alpha,this.shadow=this.shadow||shadow,this.compositeOperation=this.compositeOperation||compositeOperation},p.clone=function(){var mtx=new Matrix2D(this.a,this.b,this.c,this.d,this.tx,this.ty);return mtx.shadow=this.shadow,mtx.alpha=this.alpha,mtx.compositeOperation=this.compositeOperation,mtx},p.toString=function(){return"[Matrix2D (a="+this.a+" b="+this.b+" c="+this.c+" d="+this.d+" tx="+this.tx+" ty="+this.ty+")]"},Matrix2D.identity=new Matrix2D(1,0,0,1,0,0),window.Matrix2D=Matrix2D}(window),setTimeout((function(){(app=new DrawWorm).initialize(),interval=setInterval(demoApp,20)}),10);